<!DOCTYPE html>
<html lang="ar" dir="rtl" id="app-html">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title id="site-title-tag">المتبقي</title>
    <link rel="icon" type="image/png" href="https://i.ibb.co/fzPfcMp0/small-logo.png">
    <link href="https://fonts.googleapis.com/css2?family=IBM+Plex+Sans+Arabic:wght@400;700&display=swap" rel="stylesheet">
    <style>
        :root { --bg: #080c14; --card: #1e293b; --accent: #ffd700; --text: #ffffff; --muted: #94a3b8; --blue: #3b82f6; --box-bg: #0f172a; --nav-btn: #ffd700; }
        body.light-mode { --bg: #f8fafc; --card: #ffffff; --text: #0f172a; --muted: #475569; --box-bg: #f1f5f9; --accent: #000000; --nav-btn: #000000; }
        body { background: var(--bg); color: var(--text); font-family: 'IBM Plex Sans Arabic', sans-serif; margin: 0; padding: 20px; display: flex; flex-direction: column; align-items: center; min-height: 100vh; transition: 0.3s; }
        .toast-notification { position: fixed; top: -100px; left: 50%; transform: translateX(-50%); background: var(--blue); color: white; padding: 12px 25px; border-radius: 50px; font-weight: bold; font-size: 0.9rem; box-shadow: 0 5px 15px rgba(0,0,0,0.3); z-index: 9999; transition: top 0.5s; display: flex; align-items: center; gap: 8px; }
        .toast-notification.show { top: 25px; }
        .main-logo { width: 160px; height: auto; margin-top: 30px; }
        .site-display-title { color: var(--accent); font-size: 1.8rem; font-weight: bold; margin-bottom: 30px; }
        .controls { position: fixed; top: 15px; left: 15px; display: flex; gap: 8px; z-index: 1000; }
        .btn-tool { background: var(--nav-btn); color: var(--card); border: none; padding: 8px 12px; border-radius: 10px; cursor: pointer; font-weight: bold; }
        .card { background: var(--card); border-radius: 20px; padding: 25px; margin-bottom: 15px; width: 100%; max-width: 500px; text-align: center; position: relative; }
        .share-btn { position: absolute; top: 15px; left: 15px; background: none; border: 1px solid var(--accent); color: var(--accent); padding: 4px 8px; border-radius: 8px; cursor: pointer; font-size: 0.7rem; }
        .event-title { color: var(--accent); font-size: 1.4rem; font-weight: bold; }
        .event-date-info { font-size: 0.8rem; color: var(--muted); margin-bottom: 15px; }
        .timer-grid { display: grid; grid-template-columns: repeat(4, 1fr); gap: 5px; direction: ltr; }
        .box { background: var(--box-bg); padding: 8px 5px; border-radius: 12px; }
        .num { display: block; font-size: 1.2rem; font-weight: bold; color: var(--accent); }
        .label { font-size: 0.6rem; color: var(--muted); }
        .notify-row { margin-top: 15px; display: flex; align-items: center; justify-content: center; gap: 10px; }
        /* Switch Style */
        .switch { position: relative; width: 34px; height: 20px; }
        .switch input { opacity: 0; width: 0; height: 0; }
        .slider { position: absolute; cursor: pointer; inset: 0; background: #ccc; transition: .4s; border-radius: 34px; }
        .slider:before { position: absolute; content: ""; height: 14px; width: 14px; left: 3px; bottom: 3px; background: white; transition: .4s; border-radius: 50%; }
        input:checked + .slider { background: var(--blue); }
        input:checked + .slider:before { transform: translateX(14px); }
    </style>
</head>
<body class="dark-mode">
    <div id="top-toast" class="toast-notification"> <span id="toast-text"></span> </div>
    <div class="controls"> 
        <button class="btn-tool" onclick="toggleTheme()">نمط</button> 
        <button class="btn-tool" id="lang-btn" onclick="toggleLang()">English</button> 
    </div>

    <img src="https://i.ibb.co/DDJWNdj1/main-logo.png" class="main-logo">
    <h1 class="site-display-title" id="main-title">عداد الذكي لأيام الخير..</h1>

    <div class="card">
        <button class="share-btn" onclick="share('ramadan')">مشاركة</button>
        <div class="event-title" id="t-ramadan">شهر رمضان المبارك</div>
        <div class="event-date-info">1 رمضان 1447هـ | 18 فبراير 2026م</div>
        <div class="timer-grid">
            <div class="box"><span class="num" id="d-ramadan">0</span><span class="label">يوم</span></div>
            <div class="box"><span class="num" id="h-ramadan">0</span><span class="label">ساعة</span></div>
            <div class="box"><span class="num" id="m-ramadan">0</span><span class="label">دقيقة</span></div>
            <div class="box"><span class="num" id="s-ramadan">0</span><span class="label">ثانية</span></div>
        </div>
        <div class="notify-row">
            <span class="n-label">تفعيل التنبيه</span>
            <label class="switch"><input type="checkbox" id="sw-ramadan" onchange="toggleNotify('ramadan', this)"><span class="slider"></span></label>
        </div>
    </div>

    <script>
    const events = {
        ramadan: { date: "2026-02-18T00:00:00+03:00", pre: "2026-02-17T18:30:00+03:00", nameAr: "رمضان", nameEn: "Ramadan" },
        eid1: { date: "2026-03-20T00:00:00+03:00", pre: "2026-03-19T18:55:00+03:00", nameAr: "عيد الفطر", nameEn: "Eid al-Fitr" },
        hajj: { date: "2026-05-18T00:00:00+03:00", pre: "2026-05-17T19:00:00+03:00", nameAr: "عشر ذي الحجة", nameEn: "10 Days of Dhu al-Hijjah" },
        eid2: { date: "2026-05-27T00:00:00+03:00", pre: "2026-05-26T19:00:00+03:00", nameAr: "عيد الأضحى", nameEn: "Eid al-Adha" }
    };

    let timeouts = [];

    function updateTimers() {
        const now = Date.now();
        Object.keys(events).forEach(k => {
            const diff = new Date(events[k].date) - now;
            if (diff > 0) {
                document.getElementById(`d-${k}`).innerText = Math.floor(diff / 86400000);
                document.getElementById(`h-${k}`).innerText = Math.floor((diff % 86400000) / 3600000);
                document.getElementById(`m-${k}`).innerText = Math.floor((diff % 3600000) / 60000);
                document.getElementById(`s-${k}`).innerText = Math.floor((diff % 60000) / 1000);
            }
        });
    }
    setInterval(updateTimers, 1000);

    // حل مشكلة الإشعارات المتراكمة:
    function scheduleAll() {
        // مسح أي توقيتات قديمة لمنع التداخل
        timeouts.forEach(clearTimeout);
        timeouts = [];

        const now = Date.now();
        Object.keys(events).forEach(k => {
            if (localStorage.getItem('notif_' + k) === 'true') {
                const start = new Date(events[k].date).getTime();
                const pre = new Date(events[k].pre).getTime();

                // إشعار المغرب (قبل المناسبة) - فقط إذا كان الوقت لم يفت!
                if (pre > now) {
                    const t = setTimeout(() => {
                        new Notification("المتبقي", { body: "قرب موعد " + events[k].nameAr });
                    }, pre - now);
                    timeouts.push(t);
                }

                // إشعار وقت المناسبة - فقط إذا كان الوقت لم يفت!
                if (start > now) {
                    const t = setTimeout(() => {
                        new Notification("المتبقي", { body: "بدأ الآن " + events[k].nameAr });
                    }, start - now);
                    timeouts.push(t);
                }
            }
        });
    }

    async function toggleNotify(k, el) {
        if (el.checked) {
            const p = await Notification.requestPermission();
            if (p === "granted") {
                localStorage.setItem('notif_' + k, 'true');
                scheduleAll(); // إعادة جدولة صحيحة
                showToast("تم تفعيل التنبيه");
            } else { el.checked = false; }
        } else {
            localStorage.setItem('notif_' + k, 'false');
            scheduleAll();
            showToast("تم الإيقاف");
        }
    }

    function showToast(m) {
        const t = document.getElementById('top-toast');
        document.getElementById('toast-text').innerText = m;
        t.classList.add('show');
        setTimeout(() => t.classList.remove('show'), 3000);
    }

    function toggleTheme() {
        document.body.classList.toggle('light-mode');
        localStorage.setItem('theme', document.body.classList.contains('light-mode') ? 'light' : 'dark');
    }

    window.onload = () => {
        if(localStorage.getItem('theme') === 'light') document.body.classList.add('light-mode');
        updateTimers();
        // تفعيل المفاتيح بناء على الذاكرة
        Object.keys(events).forEach(k => {
            if(localStorage.getItem('notif_'+k) === 'true') {
                document.getElementById('sw-'+k).checked = true;
            }
        });
        scheduleAll();
    };
</script>
</body>
</html>
